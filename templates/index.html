{% extends 'base.html' %}

{% block title %}Employee Listing{% endblock %}

{% block body %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 p-3 bg-warning-subtle border rounded mb-3">
    <div class="h4 mb-0">{{ company }}</div>
    <label>Search</label>
    <input type="text" id="member-search" name="search" value="{{ search }}">
    <div class="small text-md-end">
        {% if logged_in %}
            <a class="me-2" href="/admin">Admin Dashboard</a>
            <a href="/logout">Logout</a>
        {% else %}
            <a href="/login">Admin Login</a>
        {% endif %}
    </div>
    <div class="small text-md-end">
        <button onclick="downloadExcel();" title="Download as CSV">
            <img src="{{ url_for('static', path='file_save.svg') }}" alt="Download" style="height:1.25em;vertical-align:middle;">
        </button>
    </div>
</div>

<div class="table-responsive">
<table class="table table-striped table-hover align-middle">
    <thead class="table-primary">
    <tr>
        <th>Name</th>
        <th>Department</th>
        <th>Position</th>
        <th>Phone</th>
        <th style="display:none;">Ext</th>
        <th>Mobile</th>
        <th>ID</th>
        <th style="display:none;">Email</th>
        <th style="display:none;">FirstName</th>
        <th style="display:none;">LastName</th>
    </tr>
    </thead>
    <tbody>
    {% for emp in employees %}
    <tr class="member"
        data-employee-id="{{ emp.employee_id }}"
        data-employee-text="{{ emp.name.lower() }} {{ emp.dpt.lower() }} {{ emp.position.lower() }} {{ emp.phone or '' }} {{ emp.mobile or '' }} {{ emp.employee_id or emp.id }}"
        >
        <td>
            <div class="d-flex align-items-center">
                {% if emp.img %}
                <img src="/media/{{ emp.img }}" alt="" class="rounded me-2 border" style="width:30px;height:30px;object-fit:cover;">
                {% else %}
                <span class="me-2 rounded border bg-light" style="display:inline-block;width:40px;height:40px;"></span>
                {% endif %}
                <a href="/employee/{{ emp.employee_id }}">{{ emp.name }}</a>
            </div>
        </td>
        <td>{{ emp.dpt }}</td>
        <td>{{ emp.position }}</td>
        <td>
            {{ emp.phone or '' }}
            {% if emp.ext > '' %}
                x{{ emp.ext }}
            {% endif %}
        </td>
        <td style="display:none;">{{ emp.ext }}</td>
        <td>{{ emp.mobile or '' }}</td>
        <td>{{ emp.employee_id or emp.id }}</td>
        <td style="display:none;">{{ emp.email or '' }}</td>
        <td style="display:none;">{{ emp.name | firstname }}</td>
        <td style="display:none;">{{ emp.name | lastname }}</td>
    </tr>
    {% else %}
    <tr><td colspan="6" class="text-center text-muted">No employees found.</td></tr>
    {% endfor %}
    </tbody>
</table>
</div>
<script src="{{ url_for('static', path='code.js') }}"></script>
<script>
function downloadExcel() {
    const table = document.querySelector('table');
    // Only include rows that are visible (not filtered out)
    const visibleRows = Array.from(table.querySelectorAll('tr')).filter(row => {
        // Check if the row is visible by checking if style.display is not 'none'
        return  (row.style.display !== 'none');
    });
//     const rows = Array.from(table.querySelectorAll('tr'));
    const csvContent = visibleRows.map(row => {
        const cols = Array.from(row.querySelectorAll('th, td'));
        // add quotes around each column value to handle commas in text
        return cols.map(col => {
            const text = col.textContent.trim();
            // escape double quotes by replacing them with two double quotes
            const escapedText = text.replace(/"/g, '""');
            return `"${escapedText}"`;
        }).join(',');
    }).join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'members.csv';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
}
</script>
{% endblock %}